# Notes on the conversion to ReST (with Sphinx extensions)
## Intro

This is an experiment to convert the NixOS manual to
[ReST](https://docutils.sourceforge.io/docs/ref/rst/restructuredtext.html)
with [Sphinx](https://www.sphinx-doc.org/en/stable/) extensions.

To convert DocBook files to ReST, I tried Pandoc but a lot of DocBook
directives were removed during the conversion. The Sphinx
documentation points to a [Python
script](https://github.com/wojdyr/db2rst) to convert a DocBook
document to a ReST (with Sphinx extensions) document by using lxml.

The Sphinx (the tool to generate the doc from ReST files) closure size
is currently 177MB.

## Quick start

- [An online rendered version of the
  manual](https://nlewo.github.io/nixos-manual-sphinx).

- To locally generate and render the manual:
  ```
  firefox $(nix-build -I 'nixpkgs=https://github.com/nlewo/nixpkgs/archive/manualFromReST.tar.gz' -E 'with import <nixpkgs/nixos/release.nix> {}; manualReSTHTML.x86_64-linux')/html/index.html`
  ```

## Provided ressources

- The nixpkgs branch to build the manual:
  <https://github.com/nlewo/nixpkgs/tree/manualFromReST>
   - to build the manual:
     `nix-build nixos/release.nix -A manualReSTHTML.x86_64-linux`
- A online rendered version:
    <https://nlewo.github.io/nixos-manual-sphinx>
- The generated ReST files:
    <https://github.com/nlewo/nixpkgs/tree/manualFromReST/nixos/doc/manual-rst>
- I manually improved a ReST file to show how it could look like with
  a improved conversion script:
  <https://raw.githubusercontent.com/nlewo/nixpkgs/manualFromReST/nixos/doc/manual-rst/installation/installing.xml.rst>
- The python script fork to support our DocBook manual:
  <https://github.com/nlewo/db2rst>
- The `nixos-rebuild` man page generated by Sphinx:
  ```
  man <(curl https://raw.githubusercontent.com/nlewo/nixpkgs/manualFromReST/nixos/doc/nixos-rebuild.8)
  ```

## The good

- ReST is simple
- ReST is rendered by GitHub: for trivial documentation upgrades, a
  reviewer doesn't need to generate the manual since the GitHub
  preview would be sufficient
- Sphinx detects some inconsistencies in the document (dangling
  pointers for instance)
- Sphinx is written in Python which is a language already used by
  the community (by the new NixOS module system)
- Manpages can be written in ReST and are generated by Sphinx
- Sphinx can generate XML for the next documentation conversion;)
  (needs to be explored)
- A Sphinx extension to generate the documentation of our lib by
  extracting it from source code could be developed (needs to be
  explored)
- ReST and Sphinx can be used to generate man pages
- Emacs ReST mode works well by default

## Issues/Improvements

- Implement a Sphinx cache: it takes about 5min (ReST conversion +
  HTML generation) to generate the documentation with all NixOS
  options. By only considering the 100 first options, it takes
  15sec. It would then be nice to generate a cache for the option
  documentation in order to speedup build time of the hand written
  part to make contributions more convenient. Note I don't know if
  it is possible
- Improve the ReST output: I didn't take time to improve the
  outputed ReST format. For instance, paragraph are not well
  truncated at 80 characters
- DocBook callouts: these are not supported yet (and I didn't try).
- The shown `nixos-rebuid` manpage have been manually postprocessed
  (~15min)

## Conclusion

I think ReST+Sphinx works pretty well (note I didn't know them well
before starting this experimentation). I like how ReST is easy to read
and write and I didn't notice any issues with Sphinx.

And after spending several hours comparing DocBook and ReST files, I'm
sure about one thing: we should switch to this kind of markup
languages!
